#!/bin/bash

REFLECTOR=$1
MODULE=$2
INI_FILE='/opt/USRP2M17/USRP2M17.ini'
REFLECTOR_OPTIONS='/var/www/html/m17/reflector_options.txt'

# Fetch the IP address from the reflector options file
IP_ADDRESS=$(grep "^$REFLECTOR" "$REFLECTOR_OPTIONS" | sed -E 's/.*\((.*)\).*/\1/')

if [ -z "$IP_ADDRESS" ]; then
    echo "IP address not found for reflector: $REFLECTOR" >&2
    exit 1
fi

# Update the INI file
sed -i -E "/\[M17 Network\]/,/^\[/ {s/^Name=.*/Name=$REFLECTOR $MODULE/; t; d;}" "$INI_FILE"
sed -i -E "/\[M17 Network\]/,/^\[/ {s/^Address=.*/Address=$IP_ADDRESS/; t; d;}" "$INI_FILE"

# Restart the service
systemctl restart usrp2m17
